<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigaretta - Il Gioco della Carta Piegata</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        
        .game-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .player-list {
            margin: 15px 0;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        
        .paper-strip {
            background-color: #fffcf0;
            border: 1px solid #e0d9c0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            min-height: 100px;
            position: relative;
        }
        
        .fold-line {
            border-top: 1px dashed #999;
            margin: 15px 0;
        }
        
        .entry {
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
        }
        
        .results {
            background-color: #fffcf0;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-line;
        }
        
        .instruction {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
        }
        
        .copy-code {
            display: block;
            margin: 15px auto;
        }
        
        #game-link {
            font-weight: bold;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sigaretta</h1>
        <h2>Il gioco della carta piegata</h2>
        
        <!-- Home Screen -->
        <div id="home" class="game-section">
            <div class="instruction">
                Questo è un gioco di scrittura collaborativa dove ogni giocatore scrive una parte della storia senza vedere quello che hanno scritto gli altri!
            </div>
            <button id="create-game">Crea una nuova partita</button>
            <button id="join-game">Unisciti a una partita</button>
        </div>
        
        <!-- Create Game Section -->
        <div id="create-game-section" class="game-section hidden">
            <h2>Crea una nuova partita</h2>
            <div>
                <label for="creator-name">Il tuo nome:</label>
                <input type="text" id="creator-name" placeholder="Inserisci il tuo nome">
            </div>
            <div>
                <label for="questions">Scegli le domande per la partita:</label>
                <select id="questions" multiple>
                    <option value="chi" selected>Chi? (Personaggio)</option>
                    <option value="con_chi" selected>Con chi? (Altro personaggio)</option>
                    <option value="dove" selected>Dove? (Luogo)</option>
                    <option value="cosa_facevano" selected>Cosa facevano?</option>
                    <option value="cosa_ha_detto" selected>Cosa ha detto?</option>
                    <option value="cosa_rispose" selected>Cosa rispose l'altro?</option>
                    <option value="conseguenza" selected>Quali sono state le conseguenze?</option>
                    <option value="custom">Domanda personalizzata</option>
                </select>
                <div id="custom-questions-container" class="hidden">
                    <input type="text" id="custom-question" placeholder="Inserisci una domanda personalizzata">
                    <button id="add-custom-question">Aggiungi</button>
                </div>
            </div>
            <div>
                <button id="start-game">Inizia la partita</button>
                <button class="back-home">Indietro</button>
            </div>
        </div>
        
        <!-- Join Game Section -->
        <div id="join-game-section" class="game-section hidden">
            <h2>Unisciti a una partita</h2>
            <div>
                <label for="player-name">Il tuo nome:</label>
                <input type="text" id="player-name" placeholder="Inserisci il tuo nome">
            </div>
            <div>
                <label for="game-code">Codice partita:</label>
                <input type="text" id="game-code" placeholder="Inserisci il codice della partita">
            </div>
            <button id="join-button">Unisciti</button>
            <button class="back-home">Indietro</button>
        </div>
        
        <!-- Lobby Section -->
        <div id="lobby" class="game-section hidden">
            <h2>Sala d'attesa</h2>
            <div>
                <p>Codice partita: <span id="game-code-display"></span></p>
                <p>Condividi questo link con i tuoi amici:</p>
                <div id="game-link"></div>
                <button id="copy-link">Copia link</button>
            </div>
            <div>
                <h3>Giocatori connessi:</h3>
                <div id="players-list" class="player-list"></div>
            </div>
            <div id="host-controls" class="hidden">
                <button id="start-round">Inizia il gioco</button>
            </div>
            <button id="leave-game">Abbandona la partita</button>
        </div>
        
        <!-- Game Play Section -->
        <div id="gameplay" class="game-section hidden">
            <h2>È il tuo turno!</h2>
            <div class="instruction" id="current-prompt"></div>
            <div class="paper-strip">
                <div id="previous-entries"></div>
                <div class="fold-line"></div>
                <textarea id="player-entry" rows="3" placeholder="Scrivi la tua risposta qui..." style="width: 100%; margin: 10px 0;"></textarea>
            </div>
            <button id="submit-entry">Invia e passa al prossimo giocatore</button>
        </div>
        
        <!-- Waiting Section -->
        <div id="waiting" class="game-section hidden">
            <h2>Aspetta il tuo turno</h2>
            <p>Qualcun altro sta scrivendo... attendi che sia il tuo turno!</p>
            <div id="current-player-info"></div>
        </div>
        
        <!-- Results Section -->
        <div id="results" class="game-section hidden">
            <h2>Risultati</h2>
            <div id="stories-container"></div>
            <button id="play-again">Gioca ancora</button>
            <button id="new-game">Nuova partita</button>
        </div>
        
        <div class="footer">
            &copy; 2025 Gioco della Sigaretta - Versione digitale
        </div>
    </div>
    
    <script>
        // Utility functions
        function generateRandomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function generateRandomColor() {
            const colors = [
                '#FF5733', '#33FF57', '#3357FF', '#F033FF', '#FF33A8',
                '#33FFF5', '#FFF033', '#FF8C33', '#8C33FF', '#33FF8C'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Game state
        let gameState = {
            gameId: null,
            isHost: false,
            playerName: '',
            playerColor: '',
            players: [],
            questions: [],
            currentRound: 0,
            currentPlayerIndex: 0,
            stories: [],
            gameStarted: false
        };
        
        // Default questions
        const defaultQuestions = [
            "Chi? (Personaggio)",
            "Con chi? (Altro personaggio)",
            "Dove? (Luogo)",
            "Cosa facevano?",
            "Cosa ha detto?",
            "Cosa rispose l'altro?",
            "Quali sono state le conseguenze?"
        ];
        
        // DOM elements
        const sections = {
            home: document.getElementById('home'),
            createGame: document.getElementById('create-game-section'),
            joinGame: document.getElementById('join-game-section'),
            lobby: document.getElementById('lobby'),
            gameplay: document.getElementById('gameplay'),
            waiting: document.getElementById('waiting'),
            results: document.getElementById('results')
        };
        
        // Navigation functions
        function showSection(sectionId) {
            Object.values(sections).forEach(section => {
                section.classList.add('hidden');
            });
            sections[sectionId].classList.remove('hidden');
        }
        
        // Event listeners for navigation
        document.getElementById('create-game').addEventListener('click', () => {
            showSection('createGame');
        });
        
        document.getElementById('join-game').addEventListener('click', () => {
            showSection('joinGame');
        });
        
        document.querySelectorAll('.back-home').forEach(button => {
            button.addEventListener('click', () => {
                showSection('home');
            });
        });
        
        // Create game functionality
        document.getElementById('questions').addEventListener('change', function() {
            const customOption = Array.from(this.options).find(option => option.value === 'custom');
            const customContainer = document.getElementById('custom-questions-container');
            
            if (customOption.selected) {
                customContainer.classList.remove('hidden');
            } else {
                customContainer.classList.add('hidden');
            }
        });
        
        document.getElementById('add-custom-question').addEventListener('click', function() {
            const customQuestionInput = document.getElementById('custom-question');
            const questionsSelect = document.getElementById('questions');
            
            if (customQuestionInput.value.trim()) {
                const option = document.createElement('option');
                option.value = 'custom_' + new Date().getTime();
                option.text = customQuestionInput.value.trim();
                option.selected = true;
                questionsSelect.add(option);
                customQuestionInput.value = '';
            }
        });
        
        document.getElementById('start-game').addEventListener('click', function() {
            const playerName = document.getElementById('creator-name').value.trim();
            
            if (!playerName) {
                alert('Per favore, inserisci il tuo nome!');
                return;
            }
            
            const questionsSelect = document.getElementById('questions');
            const selectedQuestions = Array.from(questionsSelect.options)
                .filter(option => option.selected && option.value !== 'custom')
                .map(option => option.text);
            
            if (selectedQuestions.length < 3) {
                alert('Seleziona almeno 3 domande per la partita!');
                return;
            }
            
            // Create new game
            gameState.gameId = generateRandomCode();
            gameState.isHost = true;
            gameState.playerName = playerName;
            gameState.playerColor = generateRandomColor();
            gameState.players = [{
                id: 'player_' + new Date().getTime(),
                name: playerName,
                color: gameState.playerColor,
                isHost: true
            }];
            gameState.questions = selectedQuestions;
            
            // Show lobby
            document.getElementById('game-code-display').textContent = gameState.gameId;
            document.getElementById('game-link').textContent = `${window.location.href.split('?')[0]}?gameId=${gameState.gameId}`;
            document.getElementById('host-controls').classList.remove('hidden');
            
            updatePlayersList();
            showSection('lobby');
        });
        
        // Join game functionality
        document.getElementById('join-button').addEventListener('click', function() {
            const playerName = document.getElementById('player-name').value.trim();
            const gameCode = document.getElementById('game-code').value.trim().toUpperCase();
            
            if (!playerName || !gameCode) {
                alert('Per favore, inserisci il tuo nome e il codice della partita!');
                return;
            }
            
            // In a real implementation, you would check if the game exists on a server
            // For this prototype, we'll just accept any code
            gameState.gameId = gameCode;
            gameState.isHost = false;
            gameState.playerName = playerName;
            gameState.playerColor = generateRandomColor();
            
            // Simulate joining a game
            gameState.players = [
                {
                    id: 'host_' + new Date().getTime(),
                    name: 'Host (simulato)',
                    color: generateRandomColor(),
                    isHost: true
                },
                {
                    id: 'player_' + new Date().getTime(),
                    name: playerName,
                    color: gameState.playerColor,
                    isHost: false
                }
            ];
            
            gameState.questions = defaultQuestions;
            
            // Show lobby
            document.getElementById('game-code-display').textContent = gameState.gameId;
            document.getElementById('game-link').textContent = `${window.location.href.split('?')[0]}?gameId=${gameState.gameId}`;
            
            updatePlayersList();
            showSection('lobby');
        });
        
        // Update players list in lobby
        function updatePlayersList() {
            const playersListElement = document.getElementById('players-list');
            playersListElement.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                const colorSpan = document.createElement('span');
                colorSpan.className = 'player-color';
                colorSpan.style.backgroundColor = player.color;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name + (player.isHost ? ' (Host)' : '');
                
                playerItem.appendChild(colorSpan);
                playerItem.appendChild(nameSpan);
                
                playersListElement.appendChild(playerItem);
            });
        }
        
        // Copy game link functionality
        document.getElementById('copy-link').addEventListener('click', function() {
            const gameLink = document.getElementById('game-link').textContent;
            navigator.clipboard.writeText(gameLink).then(() => {
                alert('Link copiato negli appunti!');
            });
        });
        
        // Leave game functionality
        document.getElementById('leave-game').addEventListener('click', function() {
            if (confirm('Sei sicuro di voler abbandonare la partita?')) {
                gameState = {
                    gameId: null,
                    isHost: false,
                    playerName: '',
                    playerColor: '',
                    players: [],
                    questions: [],
                    currentRound: 0,
                    currentPlayerIndex: 0,
                    stories: [],
                    gameStarted: false
                };
                showSection('home');
            }
        });
        
        // Start round functionality
        document.getElementById('start-round').addEventListener('click', function() {
            if (gameState.players.length < 2) {
                alert('Aspetta che si uniscano altri giocatori prima di iniziare!');
                return;
            }
            
            // Initialize stories array
            gameState.stories = gameState.players.map(player => ({
                playerId: player.id,
                entries: []
            }));
            
            gameState.gameStarted = true;
            gameState.currentRound = 0;
            gameState.currentPlayerIndex = 0;
            
            // Start the first round
            startRound();
        });
        
        function startRound() {
            // In a real implementation, you would notify all players
            // For this prototype, we'll just simulate the game flow
            
            const currentPlayerId = gameState.players[gameState.currentPlayerIndex].id;
            const currentPlayerName = gameState.players[gameState.currentPlayerIndex].name;
            
            // Check if this is your turn
            const isYourTurn = currentPlayerName === gameState.playerName;
            
            if (isYourTurn) {
                // Setup gameplay screen
                document.getElementById('current-prompt').textContent = gameState.questions[gameState.currentRound];
                document.getElementById('previous-entries').innerHTML = '';
                document.getElementById('player-entry').value = '';
                showSection('gameplay');
            } else {
                // Show waiting screen
                document.getElementById('current-player-info').textContent = `${currentPlayerName} sta scrivendo...`;
                showSection('waiting');
                
                // Simulate other player's turn
                if (!gameState.isHost) {
                    setTimeout(() => {
                        simulateOtherPlayerTurn();
                    }, 2000 + Math.random() * 3000);
                }
            }
        }
        
        // Submit entry functionality
        document.getElementById('submit-entry').addEventListener('click', function() {
            const entry = document.getElementById('player-entry').value.trim();
            
            if (!entry) {
                alert('Per favore, scrivi qualcosa prima di inviare!');
                return;
            }
            
            // Save entry to the current story
            const storyIndex = gameState.currentPlayerIndex;
            gameState.stories[storyIndex].entries.push({
                question: gameState.questions[gameState.currentRound],
                answer: entry,
                playerId: gameState.players[gameState.currentPlayerIndex].id
            });
            
            // Move to next player or next round
            moveToNextTurn();
        });
        
        function moveToNextTurn() {
            gameState.currentPlayerIndex++;
            
            // If all players have taken their turn, move to next round
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                gameState.currentPlayerIndex = 0;
                gameState.currentRound++;
                
                // If all rounds are completed, show results
                if (gameState.currentRound >= gameState.questions.length) {
                    showResults();
                    return;
                }
            }
            
            // Start next turn
            startRound();
        }
        
        function simulateOtherPlayerTurn() {
            const fakeAnswers = [
                "Il presidente della Repubblica",
                "Una bellissima ballerina",
                "Un cane parlante",
                "Un alieno verde",
                "Con il suo migliore amico",
                "Con una strega",
                "Con un calciatore famoso",
                "Al supermercato",
                "Sulla luna",
                "In una caverna segreta",
                "In una biblioteca deserta",
                "Stavano ballando il tango",
                "Preparavano una pozione magica",
                "Discutevano di filosofia",
                "Ti ho sempre amato in segreto",
                "Che bel tempo oggi, vero?",
                "Posso prendere in prestito la tua astronave?",
                "Mi dispiace, sono allergico alle tue bugie",
                "Non mangio mai prima di mezzanotte",
                "Solo se mi compri un gelato",
                "Tutti si misero a ridere",
                "Il mondo esplose in mille pezzi",
                "Decisero di adottare un pinguino",
                "Da quel giorno nessuno li ha più visti"
            ];
            
            // Save fake entry to the current story
            const storyIndex = gameState.currentPlayerIndex;
            gameState.stories[storyIndex].entries.push({
                question: gameState.questions[gameState.currentRound],
                answer: fakeAnswers[Math.floor(Math.random() * fakeAnswers.length)],
                playerId: gameState.players[gameState.currentPlayerIndex].id
            });
            
            // Move to next turn
            moveToNextTurn();
        }
        
        function showResults() {
            const storiesContainer = document.getElementById('stories-container');
            storiesContainer.innerHTML = '';
            
            // Process each story (folded paper) to create the final stories
            gameState.stories.forEach((story, index) => {
                const storyDiv = document.createElement('div');
                storyDiv.className = 'results';
                
                // Create story title (each paper belongs to a player)
                const playerName = gameState.players[index].name;
                const playerColor = gameState.players[index].color;
                
                const titleDiv = document.createElement('h3');
                titleDiv.textContent = `Storia di ${playerName}`;
                titleDiv.style.color = playerColor;
                storyDiv.appendChild(titleDiv);
                
                // Create the full story text
                let storyText = '';
                story.entries.forEach((entry, i) => {
                    const contributorName = gameState.players.find(p => p.id === entry.playerId)?.name || 'Sconosciuto';
                    const contributorColor = gameState.players.find(p => p.id === entry.playerId)?.color || '#000';
                    
                    storyText += `<div class="entry" style="border-left: 3px solid ${contributorColor}">`;
                    storyText += `<strong>${entry.question}</strong><br>`;
                    storyText += `${entry.answer} <em>(scritto da ${contributorName})</em>`;
                    storyText += `</div>`;
                });
                
                // Create a readable version of the story
                const readableStoryDiv = document.createElement('div');
                readableStoryDiv.innerHTML = `<h4>La storia completa:</h4>`;
                
                const storyParagraph = document.createElement('p');
                const readableStory = story.entries.map(entry => entry.answer).join(' ');
                storyParagraph.textContent = readableStory;
                
                readableStoryDiv.appendChild(storyParagraph);
                
                // Add both versions to the container
                const entriesDiv = document.createElement('div');
                entriesDiv.innerHTML = storyText;
                storyDiv.appendChild(entriesDiv);
                storyDiv.appendChild(document.createElement('hr'));
                storyDiv.appendChild(readableStoryDiv);
                
                storiesContainer.appendChild(storyDiv);
            });
            
            showSection('results');
        }
        
        // Play again functionality
        document.getElementById('play-again').addEventListener('click', function() {
            if (gameState.isHost) {
                // Reset game state for a new round but keep players
                gameState.currentRound = 0;
                gameState.currentPlayerIndex = 0;
                gameState.stories = [];
                gameState.gameStarted = false;
                
                // Show lobby
                showSection('lobby');
            } else {
                alert('Solo l\'host può avviare una nuova partita!');
            }
        });
        
        // New game functionality
        document.getElementById('new-game').addEventListener('click', function() {
            // Reset all game state
            gameState = {
                gameId: null,
                isHost: false,
                playerName: '',
                playerColor: '',
                players: [],
                questions: [],
                currentRound: 0,
                currentPlayerIndex: 0,
                stories: [],
                gameStarted: false
            };
            
            // Go back to home
            showSection('home');
        });
        
        // Check URL for game code on page load
        function checkUrlForGameCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('gameId');
            
            if (gameId) {
                document.getElementById('game-code').value = gameId;
                showSection('joinGame');
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            checkUrlForGameCode();
        });
    </script>
</body>
</html>
